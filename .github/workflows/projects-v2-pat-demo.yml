name: GitHub Projects v2 PAT Demo

on:
  issues:
    types: [opened]
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'add-existing-issue-to-project'
        type: choice
        options:
        - list-projects
        - list-project-items
        - create-project-item
        - create-repo-issue-and-add-to-project
        - add-existing-issue-to-project
      project_number:
        description: 'Project number (for project-specific actions)'
        required: false
        type: string
      item_title:
        description: 'Item title (for create-project-item)'
        required: false
        type: string
      issue_number:
        description: 'Issue number (for add-existing-issue-to-project)'
        required: false
        type: string

permissions:
  contents: read

jobs:
  projects-pat-demo:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v5

    - name: Auto-add new issue to project
      if: github.event_name == 'issues' && github.event.action == 'opened'
      env:
        GH_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}
      run: |
        echo "New issue #${{ github.event.issue.number }} created, adding to project..."

        PROJECT_NUMBER=2
        ISSUE_NUMBER=${{ github.event.issue.number }}

        echo "Getting project ID for project number: $PROJECT_NUMBER"
        PROJECT_ID=$(gh api graphql -f query='
        query($login: String!) {
          user(login: $login) {
            projectV2(number: '$PROJECT_NUMBER') {
              id
            }
          }
        }' -f login=${{ github.repository_owner }} --jq '.data.user.projectV2.id')

        echo "Project ID: $PROJECT_ID"

        echo "Getting issue ID for issue number: $ISSUE_NUMBER"
        ISSUE_ID=$(gh api repos/${{ github.repository }}/issues/$ISSUE_NUMBER --jq '.node_id')

        echo "Issue ID: $ISSUE_ID"

        echo "Adding issue to project..."
        gh api graphql -f query='
        mutation($projectId: ID!, $contentId: ID!) {
          addProjectV2ItemById(input: {
            projectId: $projectId
            contentId: $contentId
          }) {
            item {
              id
            }
          }
        }' -f projectId="$PROJECT_ID" -f contentId="$ISSUE_ID"

        echo "âœ… Issue #$ISSUE_NUMBER added to Project #$PROJECT_NUMBER"

        # Set initial status to "Backlog"
        echo "Setting initial status to 'Backlog'..."

        # Get the project item ID that was just created
        ITEM_ID=$(gh api graphql -f query='
        mutation($projectId: ID!, $contentId: ID!) {
          addProjectV2ItemById(input: {
            projectId: $projectId
            contentId: $contentId
          }) {
            item {
              id
            }
          }
        }' -f projectId="$PROJECT_ID" -f contentId="$ISSUE_ID" --jq '.data.addProjectV2ItemById.item.id' 2>/dev/null || true)

        if [ -z "$ITEM_ID" ]; then
          # Item already exists, get its ID
          ITEM_ID=$(gh api graphql -f query="
          {
            node(id: \"$PROJECT_ID\") {
              ... on ProjectV2 {
                items(first: 50) {
                  nodes {
                    id
                    content {
                      ... on Issue {
                        number
                      }
                    }
                  }
                }
              }
            }
          }" --jq ".data.node.items.nodes[] | select(.content.number == $ISSUE_NUMBER) | .id")
        fi

        echo "Project Item ID: $ITEM_ID"

        # Get Status field ID and Backlog option ID
        STATUS_FIELD_DATA=$(gh api graphql -f query="
        {
          node(id: \"$PROJECT_ID\") {
            ... on ProjectV2 {
              fields(first: 20) {
                nodes {
                  ... on ProjectV2SingleSelectField {
                    id
                    name
                    options {
                      id
                      name
                    }
                  }
                }
              }
            }
          }
        }" --jq '.data.node.fields.nodes[] | select(.name == "Status")')

        STATUS_FIELD_ID=$(echo "$STATUS_FIELD_DATA" | jq -r '.id')
        BACKLOG_OPTION_ID=$(echo "$STATUS_FIELD_DATA" | jq -r '.options[] | select(.name == "Backlog") | .id')

        echo "Status Field ID: $STATUS_FIELD_ID"
        echo "Backlog Option ID: $BACKLOG_OPTION_ID"

        # Update project item status to Backlog
        gh api graphql -f query='
        mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
          updateProjectV2ItemFieldValue(
            input: {
              projectId: $projectId
              itemId: $itemId
              fieldId: $fieldId
              value: {
                singleSelectOptionId: $optionId
              }
            }
          ) {
            projectV2Item {
              id
            }
          }
        }' -f projectId="$PROJECT_ID" -f itemId="$ITEM_ID" -f fieldId="$STATUS_FIELD_ID" -f optionId="$BACKLOG_OPTION_ID"

        echo "âœ… Issue #$ISSUE_NUMBER status set to 'Backlog'"

    - name: List Projects v2 with PAT
      if: github.event.inputs.action == 'list-projects'
      run: |
        echo "Listing Projects v2 for user using PAT..."
        gh api graphql -f query='
        {
          viewer {
            login
            projectsV2(first: 10) {
              totalCount
              nodes {
                id
                number
                title
                url
                shortDescription
                public
                closed
                createdAt
                updatedAt
              }
            }
          }
        }' --jq '.'

        echo ""
        echo "Formatted list:"
        gh api graphql -f query='
        {
          viewer {
            projectsV2(first: 10) {
              nodes {
                id
                number
                title
                url
                shortDescription
                public
                closed
              }
            }
          }
        }' --jq '.data.viewer.projectsV2.nodes[] | "Project #\(.number): \(.title) - \(.url) (Public: \(.public))"'
      env:
        GITHUB_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}

    - name: List Project Items with PAT
      if: github.event.inputs.action == 'list-project-items' && github.event.inputs.project_number != ''
      run: |
        echo "Listing items for project #${{ github.event.inputs.project_number }} using PAT..."

        # Get the project details and items directly using the project ID from our list query
        echo "Finding project #${{ github.event.inputs.project_number }} in user projects..."

        # First, get all projects and find the one with matching number
        PROJECT_DATA=$(gh api graphql -f query='
        {
          viewer {
            projectsV2(first: 10) {
              nodes {
                id
                number
                title
                url
              }
            }
          }
        }' --jq '.data.viewer.projectsV2.nodes[] | select(.number == ${{ github.event.inputs.project_number }})')

        if [ -z "$PROJECT_DATA" ]; then
          echo "âŒ Project #${{ github.event.inputs.project_number }} not found"
          echo "Available projects:"
          gh api graphql -f query='
          {
            viewer {
              projectsV2(first: 10) {
                nodes {
                  number
                  title
                  url
                }
              }
            }
          }' --jq '.data.viewer.projectsV2.nodes[] | "  - Project #\(.number): \(.title)"'
          exit 1
        fi

        PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')
        PROJECT_TITLE=$(echo "$PROJECT_DATA" | jq -r '.title')
        PROJECT_URL=$(echo "$PROJECT_DATA" | jq -r '.url')

        echo "âœ… Found Project: $PROJECT_TITLE"
        echo "âœ… Project ID: $PROJECT_ID"
        echo "âœ… Project URL: $PROJECT_URL"

        # Now get project items using the node query method
        echo ""
        echo "Fetching project items..."
        gh api graphql -f query="
        {
          node(id: \"$PROJECT_ID\") {
            ... on ProjectV2 {
              title
              url
              shortDescription
              items(first: 20) {
                totalCount
                nodes {
                  id
                  type
                  content {
                    __typename
                    ... on Issue {
                      title
                      number
                      url
                      state
                    }
                    ... on PullRequest {
                      title
                      number
                      url
                      state
                    }
                    ... on DraftIssue {
                      title
                    }
                  }
                }
              }
            }
          }
        }" --jq '.data.node | "Project: \(.title)\nURL: \(.url)\nTotal Items: \(.items.totalCount)\n\nItems:" + (.items.nodes | map("- \(.content.title // "Draft Item") (\(.type))") | join("\n"))'
      env:
        GITHUB_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}

    - name: Create Project Item with PAT
      if: github.event.inputs.action == 'create-project-item' && github.event.inputs.project_number != '' && github.event.inputs.item_title != ''
      run: |
        echo "Creating draft item '${{ github.event.inputs.item_title }}' in project #${{ github.event.inputs.project_number }} using PAT..."

        # Find the project ID using the same method as above
        PROJECT_DATA=$(gh api graphql -f query='
        {
          viewer {
            projectsV2(first: 10) {
              nodes {
                id
                number
                title
                url
              }
            }
          }
        }' --jq '.data.viewer.projectsV2.nodes[] | select(.number == ${{ github.event.inputs.project_number }})')

        if [ -z "$PROJECT_DATA" ]; then
          echo "âŒ Project #${{ github.event.inputs.project_number }} not found"
          exit 1
        fi

        PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')
        PROJECT_TITLE=$(echo "$PROJECT_DATA" | jq -r '.title')

        echo "âœ… Target Project: $PROJECT_TITLE"
        echo "âœ… Project ID: $PROJECT_ID"

        # Create a draft item
        gh api graphql -f query="
        mutation {
          addProjectV2DraftIssue(input: {
            projectId: \"$PROJECT_ID\"
            title: \"${{ github.event.inputs.item_title }}\"
          }) {
            projectItem {
              id
              content {
                ... on DraftIssue {
                  title
                  body
                }
              }
            }
          }
        }" --jq '.data.addProjectV2DraftIssue.projectItem | "âœ… Created item: \(.content.title) (ID: \(.id))"'
      env:
        GITHUB_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}

    - name: Create Repository Issue and Add to Project
      if: github.event.inputs.action == 'create-repo-issue-and-add-to-project' && github.event.inputs.project_number != '' && github.event.inputs.item_title != ''
      run: |
        echo "Creating repository issue '${{ github.event.inputs.item_title }}' and adding to project #${{ github.event.inputs.project_number }}..."

        # First, find the project ID
        PROJECT_DATA=$(gh api graphql -f query='
        {
          viewer {
            projectsV2(first: 10) {
              nodes {
                id
                number
                title
                url
              }
            }
          }
        }' --jq '.data.viewer.projectsV2.nodes[] | select(.number == ${{ github.event.inputs.project_number }})')

        if [ -z "$PROJECT_DATA" ]; then
          echo "âŒ Project #${{ github.event.inputs.project_number }} not found"
          exit 1
        fi

        PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')
        PROJECT_TITLE=$(echo "$PROJECT_DATA" | jq -r '.title')

        echo "âœ… Target Project: $PROJECT_TITLE"
        echo "âœ… Project ID: $PROJECT_ID"

        # Create the repository issue first using GitHub CLI
        echo ""
        echo "Creating repository issue..."

        # Create issue with proper body formatting
        gh issue create \
          --title "${{ github.event.inputs.item_title }}" \
          --body "This is a test issue created to demonstrate the issue â†’ PR â†’ CI runner workflow chain.

        ## Purpose
        - Test GitHub Projects v2 integration with repository issues
        - Validate the workflow: issue â†’ PR â†’ CI runner
        - Follow RFC naming conventions

        ## Related
        - Project: $PROJECT_TITLE
        - Workflow: GitHub Projects v2 PAT Demo
        - Created via: GitHub Actions workflow" \
          --assignee @me \
          --label "enhancement" > issue_output.txt

        ISSUE_URL=$(cat issue_output.txt)
        echo "âœ… Created repository issue: $ISSUE_URL"

        # Extract issue number
        ISSUE_NUMBER=$(echo "$ISSUE_URL" | grep -o '[0-9]*$')
        echo "âœ… Issue number: #$ISSUE_NUMBER"

        # Get the issue node ID via GraphQL
        ISSUE_NODE_ID=$(gh api graphql -f query="
        {
          repository(owner: \"${{ github.repository_owner }}\", name: \"ithome-ironman-2025\") {
            issue(number: $ISSUE_NUMBER) {
              id
              title
              url
            }
          }
        }" --jq '.data.repository.issue.id')

        echo "âœ… Issue node ID: $ISSUE_NODE_ID"

        # Add the issue to the project
        echo ""
        echo "Adding issue to project..."
        gh api graphql -f query="
        mutation {
          addProjectV2ItemById(input: {
            projectId: \"$PROJECT_ID\"
            contentId: \"$ISSUE_NODE_ID\"
          }) {
            item {
              id
              content {
                ... on Issue {
                  title
                  number
                  url
                }
              }
            }
          }
        }" --jq '.data.addProjectV2ItemById.item | "âœ… Added to project: \(.content.title) (#\(.content.number))"'

        echo ""
        echo "ðŸŽ‰ Workflow complete! Issue created and added to project."
        echo "ðŸ“‹ Issue URL: $ISSUE_URL"
        echo "ðŸ“Š Project URL: https://github.com/users/${{ github.repository_owner }}/projects/${{ github.event.inputs.project_number }}"
      env:
        GITHUB_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}

    - name: Add Existing Issue to Project
      if: github.event.inputs.action == 'add-existing-issue-to-project' && github.event.inputs.project_number != '' && github.event.inputs.issue_number != ''
      run: |
        echo "Adding existing repository issue #${{ github.event.inputs.issue_number }} to project #${{ github.event.inputs.project_number }}..."

        # First, find the project ID
        PROJECT_DATA=$(gh api graphql -f query='
        {
          viewer {
            projectsV2(first: 10) {
              nodes {
                id
                number
                title
                url
              }
            }
          }
        }' --jq '.data.viewer.projectsV2.nodes[] | select(.number == ${{ github.event.inputs.project_number }})')

        if [ -z "$PROJECT_DATA" ]; then
          echo "âŒ Project #${{ github.event.inputs.project_number }} not found"
          exit 1
        fi

        PROJECT_ID=$(echo "$PROJECT_DATA" | jq -r '.id')
        PROJECT_TITLE=$(echo "$PROJECT_DATA" | jq -r '.title')
        PROJECT_URL=$(echo "$PROJECT_DATA" | jq -r '.url')

        echo "âœ… Target Project: $PROJECT_TITLE"
        echo "âœ… Project ID: $PROJECT_ID"
        echo "âœ… Project URL: $PROJECT_URL"

        # Get the existing issue details
        echo ""
        echo "Getting issue #${{ github.event.inputs.issue_number }} details..."
        ISSUE_DATA=$(gh api graphql -f query="
        {
          repository(owner: \"${{ github.repository_owner }}\", name: \"ithome-ironman-2025\") {
            issue(number: ${{ github.event.inputs.issue_number }}) {
              id
              title
              number
              url
              state
            }
          }
        }" --jq '.data.repository.issue')

        if [ -z "$ISSUE_DATA" ] || [ "$ISSUE_DATA" = "null" ]; then
          echo "âŒ Issue #${{ github.event.inputs.issue_number }} not found"
          exit 1
        fi

        ISSUE_NODE_ID=$(echo "$ISSUE_DATA" | jq -r '.id')
        ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
        ISSUE_URL=$(echo "$ISSUE_DATA" | jq -r '.url')
        ISSUE_STATE=$(echo "$ISSUE_DATA" | jq -r '.state')

        echo "âœ… Issue: $ISSUE_TITLE"
        echo "âœ… Issue Node ID: $ISSUE_NODE_ID"
        echo "âœ… Issue URL: $ISSUE_URL"
        echo "âœ… Issue State: $ISSUE_STATE"

        # Add the issue to the project
        echo ""
        echo "Adding issue to project..."
        gh api graphql -f query="
        mutation {
          addProjectV2ItemById(input: {
            projectId: \"$PROJECT_ID\"
            contentId: \"$ISSUE_NODE_ID\"
          }) {
            item {
              id
              content {
                ... on Issue {
                  title
                  number
                  url
                }
              }
            }
          }
        }" --jq '.data.addProjectV2ItemById.item | "âœ… Added to project: \(.content.title) (#\(.content.number))"'

        echo ""
        echo "ðŸŽ‰ Workflow complete! Existing issue added to project."
        echo "ðŸ“‹ Issue: $ISSUE_TITLE (#${{ github.event.inputs.issue_number }})"
        echo "ðŸ“‹ Issue URL: $ISSUE_URL"
        echo "ðŸ“Š Project: $PROJECT_TITLE"
        echo "ðŸ“Š Project URL: $PROJECT_URL"
      env:
        GITHUB_TOKEN: ${{ secrets.USE_PROJECT_V2_TOKEN }}

    - name: Display Results Summary
      run: |
        echo "## Projects v2 PAT Demo Results" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Action performed:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
        echo "**Using:** Personal Access Token with project scopes" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Repository:** ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
        echo "**Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "This workflow demonstrates accessing personal Projects v2 using a PAT with project scopes." >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Key Differences from Built-in Token:" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Can access personal Projects v2" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Full project read/write permissions" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Works with user-level projects" >> $GITHUB_STEP_SUMMARY
        echo "- âš ï¸ Requires PAT management and rotation" >> $GITHUB_STEP_SUMMARY
