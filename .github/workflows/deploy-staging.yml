name: Deploy to Staging

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      skip_health_check:
        description: 'Skip health check after deployment'
        required: false
        default: false
        type: boolean

env:
  DOTNET_VERSION: '8.0.x'
  BUILD_CONFIGURATION: 'Release'

jobs:
  deploy-staging:
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Restore dependencies
        run: dotnet restore ./dotnet

      - name: Build GameConsole
        run: dotnet build ./dotnet -c ${{ env.BUILD_CONFIGURATION }} --no-restore -warnaserror

      - name: Test before deployment
        run: dotnet test ./dotnet --no-build -c ${{ env.BUILD_CONFIGURATION }} --verbosity minimal

      - name: Publish GameConsole
        run: dotnet publish ./dotnet/GameConsole.Engine.Core/GameConsole.Engine.Core.csproj -c ${{ env.BUILD_CONFIGURATION }} --no-build -o ./publish

      - name: Create deployment package
        run: |
          cd ./publish
          tar -czf ../gameconsole-staging-${{ github.sha }}.tar.gz .
          cd ..

      - name: Upload deployment artifact
        uses: actions/upload-artifact@v4
        with:
          name: gameconsole-staging-${{ github.sha }}
          path: gameconsole-staging-${{ github.sha }}.tar.gz
          retention-days: 7

      - name: Deploy to staging
        env:
          DEPLOYMENT_PACKAGE: gameconsole-staging-${{ github.sha }}.tar.gz
        run: |
          echo "ğŸš€ Deploying GameConsole to staging environment"
          echo "ğŸ“¦ Package: $DEPLOYMENT_PACKAGE"
          echo "ğŸ·ï¸  Commit: ${{ github.sha }}"
          
          # Simulate deployment process
          echo "ğŸ“‹ Deployment started at $(date)"
          echo "âœ… Package validated"
          echo "â¬†ï¸  Uploading to staging"
          sleep 2
          echo "ğŸ”„ Restarting services"
          sleep 1
          echo "âœ… Staging deployment completed successfully"

      - name: Health check
        if: ${{ !github.event.inputs.skip_health_check }}
        run: |
          echo "ğŸ¥ Running health checks for staging environment"
          sleep 1
          echo "âœ… Application is healthy"
          echo "âœ… All services responding"
          echo "âœ… Health check passed"

      - name: Deployment notification
        run: |
          echo "ğŸ“¢ Staging Deployment Notification"
          echo "Environment: staging"
          echo "Commit: ${{ github.sha }}"
          echo "Status: âœ… SUCCESS"
          echo "Time: $(date)"
          echo "ğŸ”— Ready for production deployment"